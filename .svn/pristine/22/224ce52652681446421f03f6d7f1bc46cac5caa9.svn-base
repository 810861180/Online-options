<template>
  <div class="region-wrap">
    <!-- 注册 -->
    <div class="region-main" v-if="!bindWx">
      <h3 v-if="type!=='updateBaseInfo'">注册</h3>
      <!-- :rules="regionRule" -->
      <!-- @keyup.enter.native="regionFormSubmit()" -->
      <el-form :model="regionForm" ref="regionForm" status-icon label-suffix=":" label-width="100px" :rules="regionRule" @keyup.enter.native="regionFormSubmit()">
        <el-form-item prop="userName" label="账号" :error="usernameError">
          <el-input v-model="regionForm.userName" maxlength="16" placeholder="帐号"></el-input>
        </el-form-item>
        <el-form-item prop="password" label="密码" v-if="type!=='updateBaseInfo'">
          <el-input v-model="regionForm.password" maxlength="16" type="password" placeholder="密码"></el-input>
        </el-form-item>
        <el-form-item prop="surePassword" label="确认密码" v-if="type!=='updateBaseInfo'">
          <el-input v-model="regionForm.surePassword" maxlength="16" type="password" placeholder="确认密码"></el-input>
        </el-form-item>
        <el-form-item prop="email" label="邮箱" :error="emailError">
          <el-input v-model="regionForm.email" type="text" placeholder="邮箱" :disabled="type==='updateBaseInfo'"></el-input>
        </el-form-item>
        <el-form-item prop="phone" label="手机号码" :error="phoneError">
          <el-input v-model="regionForm.phone" maxlength="11" type="text" placeholder="手机号码" :disabled="type==='updateBaseInfo'"></el-input>
        </el-form-item>
        <!-- <el-form-item prop="imageUrl" label="用户头像">
          <el-upload class="avatar-uploader" action="https://jsonplaceholder.typicode.com/posts/" :show-file-list="false" :on-success="handleAvatarSuccess" :before-upload="beforeAvatarUpload">
            <img v-if="imageUrl" :src="regionForm.imageUrl" class="avatar">
            <i v-else class="el-icon-plus avatar-uploader-icon"></i>
          </el-upload>
        </el-form-item> -->
        <el-form-item>
          <el-button type="primary" @click="regionFormSubmit()">提交</el-button>
          <el-button @click="resetForm()">重置</el-button>
        </el-form-item>
      </el-form>
    </div>
    <!-- 绑定微信号 -->
    <div class="bindWx" v-else>
      <div class="wxCode" ref="wxCode"></div>
    </div>
  </div>
</template>
<script>
import QRCode from 'qrcodejs2'
import { api } from '@/utils'
export default {
  data () {
    return {
      regionForm: {
        userName: '',
        password: '',
        surePassword: '',
        email: '',
        phone: ''
        // imageUrl: ''
      }, // 注册表单信息
      regionRule: {
        userName: [
          { required: true, trigger: 'blur', message: '账号不能为空' },
          { pattern: /^[a-z0-9]{5,16}$/i, message: '账号只能是5-16位字母或数字' }
        ],
        password: [
          { required: true, trigger: 'blur', message: '密码不能为空' }, {
            pattern: /^[a-z0-9]{5,16}$/i, message: '密码只能是5-16位字母或数字'
          }
        ],
        surePassword: [
          {
            trigger: 'blur',
            required: true,
            validator: (rule, value, callback) => {
              if (value === '') {
                callback(new Error('确认密码不能为空'))
              } else if (value !== this.regionForm.password) {
                callback(new Error('两次密码不一致'))
              } else {
                callback()
              }
            }
          }
        ],
        email: [
          { trigger: 'blur', type: 'email', required: true, message: '邮箱不能为空' },
          { pattern: /\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*/, message: '邮箱格式不正确' }
        ],
        phone: [
          { trigger: 'blur', required: true, message: '手机号码不能为空' },
          { pattern: /^(0|86|17951)?(13[0-9]|15[012356789]|166|17[3678]|18[0-9]|14[57])[0-9]{8}$/, message: '手机格式不正确' }
        ]
      }, // 注册表单校验
      usernameError: '',
      emailError: '',
      phoneError: '',
      bindWx: false,
      wxCode: ''
    }
  },
  props: {
    username: {
      type: String,
      default: ''
    },
    type: {
      type: String,
      default: ''
    }
  },
  methods: {
    // 注册提交表单
    regionFormSubmit () {
      this.$refs['regionForm'].validate((valid, object) => {
        console.log(valid)
        console.log(object)
        if (valid) {
          let params = {
            username: this.regionForm.userName,
            password: this.regionForm.password,
            email: this.regionForm.email,
            mobile: this.regionForm.phone
          }
          this.isExist(params)
        }
      })
    },
    // 重置注册表单
    resetForm () {
      this.$refs['regionForm'].resetFields()
    },
    // 判断是否已存在
    isExist (params) {
      this.emailError = ''
      this.usernameError = ''
      this.phoneError = ''
      api.userIsExist(params).then((data) => {
        let { result } = data
        if (result.code === 200) {
          console.log(result)
          let { email, mobile, name } = result
          this.emailError = email ? '邮箱已存在' : ''
          this.usernameError = name ? '账号已存在' : ''
          this.phoneError = mobile ? '手机号已存在' : ''
          if (!email && !mobile && !name) {
            this.regionUser(params)
          }
        } else {
          this.$message.error(data.message)
        }
      })
      // return api.userIsExist(params)
    },
    // 注册接口
    regionUser (params) {
      const loading = this.$loading({
        lock: true,
        text: 'Loading',
        spinner: 'el-icon-loading',
        background: 'rgba(0, 0, 0, 0.7)'
      })
      api.regionUser(params).then((data) => {
        console.log(data)
        if (data.code === 200) {
          loading.close()
          this.$confirm('注册成功！是否绑定微信号', '温馨提示', {
            confirmButtonText: '确定',
            cancelButtonText: '取消绑定',
            type: 'success'
          }).then(() => {
            this.bindWx = true
            this.$nextTick(() => {
              this.getWxCode(data.data)
            })
          }).catch(() => {
            this.$message({
              type: 'info',
              message: '取消绑定讲无法使用微信扫码登录'
            })
            this.bindWx = false
            this.$refs['regionForm'].clearValidate()
          })
        } else {
          this.$message.error(data.message)
        }
      })
    },
    // 获取绑定二维码
    getWxCode (userId) {
      let wxCode = new QRCode(this.$refs['wxCode'], {
        text: this.$axios.adornUrl(api.bindWx(userId)),
        width: 190,
        height: 190,
        colorDark: '#000',
        colorLight: '#fff',
        correctLevel: QRCode.CorrectLevel.H
      })
      return wxCode
    }
  },
  created () {
    this.regionForm.userName = this.username !== '' ? this.username : ''
    if (this.type === 'updateBaseInfo') {
      let userinfo = JSON.parse(this.$cookie.get('userinfo'))
      console.log(userinfo.id)
      api.getUserInfoByUserId(userinfo.id).then((data) => {
        console.log(data)
      })
    }
  }
}
</script>
<style lang="scss" scoped>
.region-wrap {
  position: absolute;
  top: 210px;
  left: 100px;
  padding: 40px 60px;
  width: 470px;
  background-color: $light;
}
.region-main {
  // position: absolute;
  // top: 200px;
  // left: 25%;
  // width: 470px;
  // padding: 10px 0 0;
  // background-color: $light;
  > h3 {
    margin-bottom: 10px;
    text-align: center;
  }
}
.bindWx {
  > .wxCode {
    width: 210px;
    height: 210px;
    margin: 0 auto;
    padding: 10px;
    background-color: $light;
  }
}
</style>
