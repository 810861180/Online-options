<template>
  <div class="site-wrapper site-page--login">
    <!-- 登录 -->
    <div class="login-main" v-if="isLogin">
      <!-- <h3 class="login-title">账号密码登录</h3> -->
      <div class="login-type">
        <label :class="{'active-type':loginType===1}" @click="changeLoginType(1)">账号密码登录</label>
        <span>|</span>
        <label :class="{'active-type':loginType===2}" @click="changeLoginType(2)">扫码登录</label>
      </div>
      <el-form v-if="!wxLogin" :model="loginForm" :rules="loginRule" ref="loginForm" @keyup.enter.native="loginFormSubmit()" status-icon>
        <el-form-item prop="userName">
          <el-input v-model="loginForm.userName" maxlength="16" placeholder="帐号"></el-input>
        </el-form-item>
        <el-form-item prop="password">
          <el-input v-model="loginForm.password" maxlength="16" type="password" placeholder="密码"></el-input>
        </el-form-item>
        <el-form-item prop="captcha">
          <el-row :gutter="20">
            <el-col :span="14">
              <el-input v-model="loginForm.captcha" maxlength="16" placeholder="验证码">
              </el-input>
            </el-col>
            <el-col :span="10" class="login-captcha">
              <img :src="captchaPath" @click="getCaptcha()" alt="">
            </el-col>
          </el-row>
        </el-form-item>
        <!-- <el-form-item prop="checked">
          <el-checkbox v-model="loginForm.checked">记住密码</el-checkbox>
        </el-form-item> -->
        <el-form-item>
          <el-button class="login-btn-submit" type="primary" @click="loginFormSubmit()">登录</el-button>
        </el-form-item>
      </el-form>
      <div class="wxLogin" v-show="wxLogin">
        <div id="loginWxCode" ref="loginWxCode" @click="getWxCode()"></div>
        <p class="wxTips">请使用微信扫描二维码登录</p>
      </div>
      <p class="btn-region">暂无账号，<label @click="isLogin=false">注册</label></p>
    </div>
    <!-- 注册 -->
    <region v-else :username='loginForm.userName'></region>
  </div>
</template>

<script>
import QRCode from 'qrcodejs2'
import Region from '@/components/region'
import { getUUID, api } from '@/utils'
export default {
  data () {
    // 账号校验规则
    let validateUsername = (rule, value, callback) => {
      if (value === '') {
        callback(new Error('帐号不能为空'))
      } else if (!(/^[a-z0-9]{5,16}$/i).test(value)) {
        callback(new Error('账号只能是5-16位字母或数字'))
      } else {
        // 用户是否存在，不存在则注册
        api.userIsExist({ username: value }).then((data) => {
          let { result } = data
          if (result && result.code === 200) {
            if (this.isLogin) {
              if (result.name) {
                callback()
              } else {
                this.$message.error('当前用户不存在，请先注册')
                this.isLogin = false
                this.$set(this.regionForm, 'userName', value)
                this.$refs.regionForm.clearValidate()
              }
            } else {
              if (result.name) {
                callback(new Error('账号已存在'))
              } else {
                callback()
              }
            }
          } else {
            // this.$message.error(data.message)
            this.$notify.error({
              title: 'Info',
              message: data.message,
              showClose: false
            })
          }
        })
      }
    }
    // 密码校验规则
    let validatePassword = (rule, value, callback) => {
      if (value === '') {
        callback(new Error('密码不能为空'))
      } else if (!(/^[a-z0-9]{5,16}$/i).test(value)) {
        callback(new Error('账号只能是5-16位字母或数字'))
      } else {
        callback()
      }
    }
    // 验证码校验规则
    let validateCaptcha = (rule, value, callback) => {
      if (value === '') {
        callback(new Error('验证码不能为空'))
      } else if (!(/^[\s\S]*.*[^\s][\s\S]*$/).test(value)) {
        callback(new Error('验证码不能为空'))
      } else {
        callback()
      }
    }
    return {
      loginType: 1,
      loginForm: {
        userName: '',
        password: '',
        uuid: getUUID(),
        captcha: ''
      },
      loginRule: {
        userName: [
          { min: 5, max: 16, trigger: 'blur', validator: validateUsername }
        ],
        password: [
          { min: 6, max: 16, trigger: 'blur', validator: validatePassword }
        ],
        captcha: [
          { trigger: 'blur', validator: validateCaptcha }
        ]
      },
      captchaPath: '', // 验证码路径
      userInfo: {}, // 用户信息
      isLogin: true, // 登录or注册
      wxLogin: false, // 微信登录
      websocket: '',
      wx_uri: ''
    }
  },
  components: {
    Region
  },
  methods: {
    // 切换登录方式
    changeLoginType (type) {
      this.loginType = type
      if (type === 1) {
        this.wxLogin = false
      } else {
        this.wxLogin = true
      }
    },
    // 登录提交表单
    loginFormSubmit () {
      this.$refs['loginForm'].validate((valid) => {
        if (valid) {
          const loading = this.$loading({
            lock: true,
            text: 'Loading',
            spinner: 'el-icon-loading',
            background: 'rgba(0, 0, 0, 0.7)'
          })
          let params = {
            username: this.loginForm.userName,
            password: this.loginForm.password,
            kaptcha: this.loginForm.captcha,
            uuid: this.loginForm.uuid
          }
          api.login(params).then((data) => {
            if (data && data.code === 200) {
              let userInfo = data.data
              loading.close()
              this.$cookie.set('token', userInfo.access_token)
              // this.$store.commit('user/setUserInfo', JSON.stringify(userInfo))

              this.$notify.success({
                title: 'Info',
                message: '登录成功',
                showClose: false
              })
              this.$router.replace({ name: 'home' })
              this.userInfo = userInfo
              // this.setUserInfo()
              this.$cookie.set('userinfo', JSON.stringify(this.userInfo))
            } else {
              setTimeout(() => {
                this.getCaptcha()
                this.$notify.error({
                  title: 'Info',
                  message: data.message,
                  showClose: false
                })
                // this.$message.error(data.message)
                loading.close()
              }, 500)
            }
          })
        }
      })
    },
    // 获取验证码
    getCaptcha () {
      this.captchaPath = this.$axios.adornUrl(api.captcha() + `?uuid=${this.loginForm.uuid}&t=` + Math.random())
    },
    // 获取登录二维码
    getWxCode () {
      // this.$refs['loginWxCode'].childNodes.remove()
      console.log(this.$refs['loginWxCode'].childNodes)
      // console.log(document.getElementById('loginWxCode').children)
      document.getElementById('loginWxCode').innerHTML = ''
      api.getWxCode().then((data) => {
        if (data.code === 200) {
          let { uri, uuid } = data.data
          let wxUrl = data.data.wx_uri
          let loginWxCode = new QRCode(this.$refs['loginWxCode'], {
            text: uri + '/wx/signin?uuid=' + uuid + '&type=PC',
            width: 190,
            height: 190,
            colorDark: '#000',
            colorLight: '#fff',
            correctLevel: QRCode.CorrectLevel.H
          })
          this.initWebSocket(uuid, wxUrl)
          return loginWxCode
        } else {
          this.$message.error(data.message)
        }
      })
    },
    // websocket通信
    initWebSocket (uuid, wxUrl) {
      this.websocket = new WebSocket(wxUrl)
      this.websocket.onopen = () => {
        console.log('连接成功')
        this.websocket.send(JSON.stringify({ 'uuid': uuid, 'wxScanLogin': 'PC*APP', 'type': 'SCANLOGIN' }))
      }
      this.websocket.onmessage = (event) => {
        console.log(event.data)
        let { feedback, confirm, data, msgContent } = JSON.parse(event.data)
        console.log(confirm)
        console.log(data)
        if (feedback === 0) { // 扫码成功
          // this.$message.warning(`${msgContent}`)
          this.$notify.warning({
            title: 'Info',
            message: `${msgContent}`,
            showClose: false
          })
        } else {
          if (confirm === 'CANCEL') { // 取消登录
            // this.$message.warning(`${msgContent}`)
            this.$notify.warning({
              title: 'Info',
              message: `${msgContent}`,
              showClose: false
            })
          } else if (confirm === 'DETERMINE') { // 登录成功
            // this.$message.success(`${msgContent}`)
            this.$notify.success({
              title: 'Info',
              message: `${msgContent}`,
              showClose: false
            })
            this.$cookie.set('token', data.access_token)
            this.$router.replace({ name: 'home' })
            this.userInfo = data
            // this.setUserInfo()
            this.$cookie.set('userinfo', JSON.stringify(this.userInfo))
          }
        }
      }
    }
  },
  created () {
    this.getCaptcha()
    if (this.isLogin) {
      // 获取微信二维码
      this.$nextTick(() => {
        this.getWxCode()
      })
    }
  },
  destroyed () {
    this.websocket.close()
  }
}
</script>

<style lang='scss' scoped>
.site-page--login {
  position: absolute;
  top: 0;
  right: 0;
  bottom: 0;
  left: 0;
  background-color: rgba(38, 50, 56, 0.6);
  overflow: hidden;
  .login-main {
    position: absolute;
    top: 210px;
    right: 100px;
    padding: 40px 60px;
    width: 470px;
    background-color: $light;
    .login-type {
      margin-bottom: 10px;
      text-align: center;
      font-weight: $bold;
      > label {
        font-size: $size16;
        &:hover,
        &:active {
          cursor: pointer;
          color: rgba($color: $--color-primary, $alpha: 0.7) !important;
        }
        &.active-type {
          color: $--color-primary;
        }
      }
      > span {
        margin: 0 5px;
      }
    }
    .wxLogin {
      > #loginWxCode {
        width: 210px;
        height: 210px;
        margin: 0 auto;
        padding: 10px;
        background-color: $light;
      }
      > p.wxTips {
        background: rgba($color: $black, $alpha: 0.4);
        border-radius: 50px;
        width: 70%;
        text-align: center;
        padding: 10px 0;
        margin: 0 auto;
        margin-bottom: 0px;
        color: $light;
      }
    }
    .btn-region {
      > label {
        cursor: pointer;
        color: $--color-primary;
      }
    }
  }
}
</style>
